<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Store Backup System</title>
<link rel="stylesheet" href="style.css">
<style>
/* ===== PREVIEW AREA ===== */
#previewArea {
  padding: 10px;
  border: 1px solid #ccc;
  margin-top: 10px;
  background: #f9f9f9;
}
#previewBox video,
#previewBox audio,
#previewBox img,
#previewBox iframe {
  max-width: 100%;
  max-height: 80vh;
}
/* ===== FILE LIST ===== */
#fileList {
  list-style: none;
  padding: 0;
}
.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px;
  border-bottom: 1px solid #ddd;
}
.menu-wrapper {
  position: relative;
}
.menu {
  display: none;
  position: absolute;
  right: 0;
  top: 20px;
  background: #fff;
  border: 1px solid #ccc;
  padding: 5px;
  z-index: 10;
  border-radius: 4px;
}
.menu button {
  display: block;
  width: 100%;
  margin: 2px 0;
  text-align: left;
  background: none;
  border: none;
  cursor: pointer;
  padding: 2px 5px;
}
.menu button:hover {
  background: #f0f0f0;
}
.highlight {
  background-color: yellow;
}
</style>
</head>

<body>

<h1>File Store Backup System</h1>

<!-- ================= LOGIN & SIGNUP ================= -->
<section id="loginSection">
  <h3>Login</h3>
  <input type="text" id="username" placeholder="Enter Email or Username"><br>
  <input type="password" id="password" placeholder="Password">
  <button type="button" onclick="togglePassword('password')">üëÅ</button><br><br>
  <button id="loginBtn">Login</button>
  <p id="loginMsg" style="color:red;"></p>

  <hr>

  <h3>Sign Up</h3>
  <input type="text" id="signupUsername" placeholder="Enter Email or New Username"><br>
  <input type="password" id="signupPassword" placeholder="Password">
  <button type="button" onclick="togglePassword('signupPassword')">üëÅ</button><br><br>
  <input type="password" id="signupConfirmPassword" placeholder="Confirm Password">
  <button id="signupBtn">Sign Up</button>
  <p id="signupMsg"></p>
</section>

<!-- ================= MAIN APP ================= -->
<section id="mainSection" style="display:none;">

  <button id="settingsBtn">Settings</button>

  <!-- ===== SETTINGS PANEL ===== -->
  <div id="settingsPanel" style="display:none;">
    <button id="settingsBackBtn">‚¨Ö Back</button><br><br>
    <h4>Settings</h4>
    <button id="backupBtn">Backup Now</button><br><br>
    <input type="date" id="restoreDate">
    <button id="restoreBtn">Restore Backup</button>

    <hr>
    <h4>Account Settings</h4>
    <input type="text" id="newUsername" placeholder="New username"><br><br>
    <input type="password" id="newPassword" placeholder="New password"><br><br>
    <input type="password" id="confirmPassword" placeholder="Confirm new password"><br><br>
    <button id="updateAccountBtn">Update Account</button>
    <p id="accountMsg" style="color:red;"></p>

    <button id="logoutBtn">Logout</button>

    <label>Sort by:</label>
    <select id="sortSelect">
      <option value="a-z">A‚ÄìZ</option>
      <option value="z-a">Z‚ÄìA</option>
      <option value="date">Date</option>
    </select>
  </div>

  <hr>

  <!-- ===== FILES AREA ===== -->
  <div id="filesArea">
    <h3>Upload File</h3>
    <form id="uploadForm">
      <input type="file" id="fileInput" name="file" required>
      <button type="submit">Upload</button>
    </form>

    <h3>Search & Stored Files</h3>
    <ul id="fileList"></ul>
  </div>

  <!-- ===== PREVIEW AREA ===== -->
  <div id="previewArea" style="display:none;">
    <h3>Preview</h3>
    <div id="previewBox"></div>
  </div>

</section>

<script>
// ===== PASSWORD TOGGLE =====
function togglePassword(id){
  const input = document.getElementById(id);
  input.type = input.type === "password" ? "text" : "password";
}

// ===== MAIN SCRIPT =====
const API = "http://localhost:5000";
let loggedInUser = null;

const loginSection = document.getElementById("loginSection");
const mainSection = document.getElementById("mainSection");
const loginBtn = document.getElementById("loginBtn");
const loginMsg = document.getElementById("loginMsg");
const logoutBtn = document.getElementById("logoutBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const settingsBackBtn = document.getElementById("settingsBackBtn");
const fileListEl = document.getElementById("fileList");
const filesArea = document.getElementById("filesArea");
const previewArea = document.getElementById("previewArea");
const previewBox = document.getElementById("previewBox");
const sortSelect = document.getElementById("sortSelect");
const fileInput = document.getElementById("fileInput");

// ===== SEARCH INPUT =====
const searchInput = document.createElement("input");
searchInput.placeholder = "Search files...";
searchInput.style.width = "100%";
searchInput.style.marginBottom = "10px";
fileListEl.parentNode.insertBefore(searchInput, fileListEl);

// ===== SIGNUP =====
document.getElementById("signupBtn").onclick = async () => {
  const username = document.getElementById("signupUsername").value.trim();
  const password = document.getElementById("signupPassword").value.trim();
  const confirmPassword = document.getElementById("signupConfirmPassword").value.trim();
  const msg = document.getElementById("signupMsg");
  msg.textContent = ""; msg.style.color = "red";

  if(!username || !password || !confirmPassword){ 
    msg.textContent="Enter all fields"; 
    return; 
  }
  if(password !== confirmPassword){
    msg.textContent="Passwords do not match";
    return;
  }

  try {
    const res = await fetch(`${API}/signup`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username,password})
    });
    const data = await res.json();
    msg.style.color = data.success ? "green":"red";
    msg.textContent = data.message;

    if(data.success){
      loggedInUser = username;           
      loginSection.style.display = "none"; 
      mainSection.style.display = "block"; 
      fileInput.value = "";               
      searchInput.value = "";             
      loadFiles();                        
    }

  } catch { msg.textContent = "Signup failed"; }
};

// ===== LOGIN =====
loginBtn.onclick = async () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  loginMsg.textContent="";
  if(!username || !password){ loginMsg.textContent="Enter username and password"; return; }
  try {
    const res = await fetch(`${API}/login`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username,password})
    });
    const data = await res.json();
    if(!data.success){ loginMsg.textContent=data.message; return; }
    loggedInUser = username;
    loginSection.style.display="none";
    mainSection.style.display="block";
    loadFiles();
  } catch { loginMsg.textContent="Server error"; }
};

// ===== LOGOUT =====
logoutBtn.onclick = () => {
  loggedInUser = null;
  loginSection.style.display = "block";
  mainSection.style.display = "none";
  fileListEl.innerHTML = "";
  previewBox.innerHTML = "";
  filesArea.style.display = "block";
  previewArea.style.display = "none";
  settingsPanel.style.display = "none";
  settingsBtn.style.display = "inline-block";
};

// ===== SETTINGS LIKE PAGE =====
settingsBtn.onclick = () => {
  filesArea.style.display = "none";
  previewArea.style.display = "none";
  settingsBtn.style.display = "none";
  settingsPanel.style.display = "block";
};
settingsBackBtn.onclick = () => {
  settingsPanel.style.display = "none";
  filesArea.style.display = "block";
  settingsBtn.style.display = "inline-block";
};

// ===== LOAD FILES =====
async function loadFiles() {
  if(!loggedInUser) return;
  try {
    const res = await fetch(`${API}/files?username=${loggedInUser}`);
    let files = await res.json();
    const searchTerm = searchInput.value.toLowerCase();

    if(searchTerm) files = files.filter(f=>f.name.toLowerCase().includes(searchTerm));

    const sortType = sortSelect.value;
    if(sortType==="a-z") files.sort((a,b)=>a.name.localeCompare(b.name));
    if(sortType==="z-a") files.sort((a,b)=>b.name.localeCompare(a.name));
    if(sortType==="date") files.sort((a,b)=>new Date(b.date)-new Date(a.date));

    fileListEl.innerHTML=""; previewBox.innerHTML="";

    files.forEach(f=>{
      let displayName = f.name;
      if(searchTerm){
        const regex = new RegExp(`(${searchTerm})`, "gi");
        displayName = f.name.replace(regex, '<span class="highlight">$1</span>');
      }
      const nameEnc = encodeURIComponent(f.name);
      fileListEl.innerHTML+=`
        <li class="file-item">
          <span class="file-name">${displayName}</span>
          <div class="menu-wrapper">
            <button class="menu-btn" onclick="toggleMenu(this)">‚ãÆ</button>
            <div class="menu">
              <button onclick="previewFile('${nameEnc}','${f.type}')">View</button>
              <button onclick="downloadFile('${nameEnc}')">Download</button>
              <button onclick="renameFile('${nameEnc}')">Rename</button>
              <button onclick="deleteFile('${nameEnc}')">Delete</button>
            </div>
          </div>
        </li>
      `;
    });
  } catch { alert("Failed to load files"); }
}

// ===== DOWNLOAD FILE WITH CONFIRMATION =====
function downloadFile(fileName){
  if(!confirm("Do you want to download this file?")) return;
  const link = document.createElement("a");
  link.href = `${API}/download/${loggedInUser}/${fileName}`;
  link.download = decodeURIComponent(fileName);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ===== SEARCH & SORT =====
sortSelect.addEventListener("change", loadFiles);
searchInput.addEventListener("input", loadFiles);

// ===== MENU =====
function toggleMenu(btn){
  document.querySelectorAll(".menu").forEach(m=>{ if(m!==btn.nextElementSibling) m.style.display="none"; });
  const menu=btn.nextElementSibling;
  menu.style.display=menu.style.display==="block"?"none":"block";
}
document.addEventListener("click",e=>{
  if(!e.target.closest(".menu-wrapper")){ document.querySelectorAll(".menu").forEach(m=>m.style.display="none"); }
});

// ===== PREVIEW =====
function previewFile(name,type){
  const url=`${API}/preview/${loggedInUser}/${name}`;
  let content="";
  if(type===".mp4") content=`<video controls src="${url}"></video>`;
  else if(type===".mp3") content=`<audio controls src="${url}"></audio>`;
  else if([".jpg",".jpeg",".png",".gif"].includes(type)) content=`<img src="${url}">`;
  else content=`<iframe src="${url}"></iframe>`;
  filesArea.style.display="none";
  settingsPanel.style.display="none";
  settingsBtn.style.display="none";
  previewArea.style.display="block";
  previewBox.innerHTML=`<button onclick="closePreview()">‚¨Ö Back</button><br><br>${content}`;
}
function closePreview(){
  previewBox.innerHTML="";
  previewArea.style.display="none";
  filesArea.style.display="block";
  settingsBtn.style.display="inline-block";
}

// ===== DELETE =====
async function deleteFile(name){
  if(!confirm("Delete this file?")) return;
  await fetch(`${API}/delete/${loggedInUser}/${decodeURIComponent(name)}`,{method:"DELETE"});
  loadFiles();
}

// ===== RENAME =====
async function renameFile(oldName){
  const dotIndex = oldName.lastIndexOf(".");
  const baseName = dotIndex !== -1 ? oldName.substring(0,dotIndex) : oldName;
  const extension = dotIndex !== -1 ? oldName.substring(dotIndex) : "";
  const newNameInput = prompt("Enter new file name:", baseName);
  if(!newNameInput) return;
  const newName = newNameInput + extension;
  await fetch(`${API}/rename`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:loggedInUser, oldName:decodeURIComponent(oldName), newName})
  });
  loadFiles();
}

// ===== UPLOAD =====
document.getElementById("uploadForm").onsubmit = async e => {
  e.preventDefault();
  if(!loggedInUser) return alert("Not logged in");
  const formData = new FormData(e.target);
  formData.append("username", loggedInUser);
  try {
    const res = await fetch(`${API}/upload`,{method:"POST",body:formData});
    const data = await res.json();
    alert(data.message);
    fileInput.value = "";
    loadFiles();
  } catch { alert("Upload failed"); }
};

// ===== BACKUP =====
document.getElementById("backupBtn").onclick=async()=>{
  const res=await fetch(`${API}/backup`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:loggedInUser})
  });
  const data=await res.json(); alert(data.message);
};

// ===== RESTORE =====
document.getElementById("restoreBtn").onclick=async()=>{
  const date=document.getElementById("restoreDate").value;
  if(!date) return alert("Select date");
  if(!confirm("Restore will overwrite files. Continue?")) return;
  const res=await fetch(`${API}/restore`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:loggedInUser,date})
  });
  const data=await res.json();
  alert(data.message);
  loadFiles();
};

// ===== UPDATE ACCOUNT =====
document.getElementById("updateAccountBtn").onclick = async () => {
  const newUsername = document.getElementById("newUsername").value.trim();
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const msg = document.getElementById("accountMsg");
  msg.textContent=""; msg.style.color="red";
  if(!newUsername || !newPassword || !confirmPassword){ msg.textContent="All fields required"; return; }
  if(newPassword!==confirmPassword){ msg.textContent="Passwords do not match"; return; }
  try {
    const res = await fetch(`${API}/update-account`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username:loggedInUser,newUsername,newPassword})
    });
    const data = await res.json();
    msg.style.color = data.success ? "green":"red";
    msg.textContent = data.message;
    if(data.success){
      loggedInUser=newUsername;
      document.getElementById("newUsername").value="";
      document.getElementById("newPassword").value="";
      document.getElementById("confirmPassword").value="";
      loadFiles();
    }
  } catch { msg.style.color="red"; msg.textContent="Update failed"; }
};
</script>

</body>
</html>
